<!doctype html>
<html lang="uk" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BIOLOGY SMART-HUB 2.0</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <!-- Handwriting font for score -->
  <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@700&display=swap" rel="stylesheet">

  <style>
    :root {
      --line-height: 28px; /* –í–∏—Å–æ—Ç–∞ –ª—ñ–Ω—ñ—ó –≤ –∑–æ—à–∏—Ç—ñ */
    }

    html, body { 
      font-family: 'Inter', system-ui, -apple-system, sans-serif; 
      background-color: #0f172a; /* Slate 950 */
      color: #f1f5f9; /* Slate 100 */
    }
    
    .font-handwriting {
      font-family: 'Caveat', cursive;
    }

    /* --- –î—Ä—É–∫ --- */
    @media print {
      @page { margin: 1cm; size: A4; }
      .no-print { display: none !important; }
      body { background: #fff !important; color: #111827 !important; print-color-adjust: exact; -webkit-print-color-adjust: exact; }
      #app { display: none !important; }
      #printArea { display: block !important; }
    }

    /* --- –ï—Ñ–µ–∫—Ç –ø–∞–ø–µ—Ä—É --- */
    .paper {
      background: #ffffff;
      color: #111827;
      border: 1px solid #e2e8f0;
      border-radius: 16px;
      box-shadow: 
        0 4px 6px -1px rgba(0, 0, 0, 0.1),
        0 2px 4px -1px rgba(0, 0, 0, 0.06),
        0 20px 25px -5px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      position: relative;
    }
    
    .paper-header {
      padding: 20px 24px 16px;
      border-bottom: 2px solid #e2e8f0;
      background: linear-gradient(to bottom, #ffffff, #f8fafc);
    }

    .paper-title {
      font-weight: 800;
      font-size: 20px;
      letter-spacing: -0.025em;
      color: #0f172a;
    }
    
    .paper-sub {
      margin-top: 4px;
      color: #64748b;
      font-size: 13px;
      font-weight: 500;
    }

    /* --- –õ—ñ–Ω–æ–≤–∞–Ω–∏–π —Ñ–æ–Ω --- */
    .lined {
      position: relative;
      background-color: #fff;
      background-image: repeating-linear-gradient(to bottom, transparent 0px, transparent calc(var(--line-height) - 1px), #e2e8f0 calc(var(--line-height) - 1px), #e2e8f0 var(--line-height));
      min-height: 400px;
    }
    
    /* –ß–µ—Ä–≤–æ–Ω–µ –ø–æ–ª–µ –∑–ª—ñ–≤–∞ */
    .lined::before {
      content: "";
      position: absolute;
      top: 0; left: 40px;
      width: 2px;
      height: 100%;
      background: rgba(239, 68, 68, 0.3); /* Red-500 opacity */
      z-index: 10;
      pointer-events: none;
    }

    /* --- –ï–ª–µ–º–µ–Ω—Ç–∏ —Ñ–æ—Ä–º–∏ –≤ –ø–∞–ø–µ—Ä–æ–≤–æ–º—É —Å—Ç–∏–ª—ñ --- */
    .field-label {
      font-size: 11px;
      color: #64748b;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 6px;
    }

    .paper-card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(4px);
      border: 1px solid #cbd5e1;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    /* –Ü–Ω–ø—É—Ç–∏ –Ω–∞ –ø–∞–ø–µ—Ä—ñ */
    .paper input, .paper select {
      background: #f8fafc !important;
      color: #0f172a !important;
      border: 1px solid #cbd5e1 !important;
      border-radius: 8px !important;
      font-size: 14px;
      transition: all 0.2s;
    }
    .paper input:focus, .paper select:focus {
      border-color: #3b82f6 !important;
      outline: none;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    /* –¢–µ–∫—Å—Ç–æ–≤–µ –ø–æ–ª–µ, —è–∫–µ –ª—è–≥–∞—î –Ω–∞ –ª—ñ–Ω—ñ—ó */
    .paper textarea.lined-input {
      background: transparent !important;
      border: none !important;
      border-radius: 0 !important;
      padding: 0;
      padding-left: 56px; /* –í—ñ–¥—Å—Ç—É–ø –≤—ñ–¥ —á–µ—Ä–≤–æ–Ω–æ—ó –ª—ñ–Ω—ñ—ó */
      padding-right: 16px;
      width: 100%;
      line-height: var(--line-height);
      font-size: 16px;
      color: #1e293b;
      resize: vertical;
      outline: none;
      margin-top: 1px; /* –¢–æ–Ω–∫–µ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è */
      font-family: 'Inter', sans-serif; 
    }
    .paper textarea.lined-input::placeholder {
      color: #94a3b8;
      font-style: italic;
    }
    .paper textarea.lined-input:focus {
      background: rgba(59, 130, 246, 0.02) !important;
    }

    /* –ö–Ω–æ–ø–∫–∏ */
    .btn-dark {
      background: #0f172a;
      color: white;
      font-weight: 600;
      border-radius: 8px;
      padding: 8px 16px;
      transition: background 0.2s;
    }
    .btn-dark:hover { background: #1e293b; }

    .nav-link {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.2s;
      color: #94a3b8;
    }
    .nav-link:hover {
      background: rgba(30, 41, 59, 0.5);
      color: #f8fafc;
    }
    .nav-link.active {
      background: #1e293b;
      color: #34d399; /* Emerald 400 */
    }

    /* –ê–Ω—ñ–º–∞—Ü—ñ—ó */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    .fade-in { animation: fadeIn 0.3s ease-out forwards; }
  </style>
</head>

<body>
  <!-- –ì–æ–ª–æ–≤–Ω–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–æ–¥–∞—Ç–∫–∞ -->
  <div id="app" class="min-h-screen flex flex-col"></div>
  
  <!-- –°–µ–∫—Ü—ñ—è –¥–ª—è –¥—Ä—É–∫—É (–ø—Ä–∏—Ö–æ–≤–∞–Ω–∞ –≤ –∑–≤–∏—á–∞–π–Ω–æ–º—É —Ä–µ–∂–∏–º—ñ) -->
  <section id="printArea" class="hidden bg-white text-black"></section>

  <script>
    // -------------------------
    // 0) –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Ø –¢–ê –î–ê–ù–Ü
    // -------------------------
    const OPP_LIST = [
      "–í–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–æ —ñ –ø–µ—Ä–µ—Ä–æ–±–∫–∞ –ø—Ä–æ–¥—É–∫—Ü—ñ—ó —Ä–æ—Å–ª–∏–Ω–Ω–∏—Ü—Ç–≤–∞",
      "–ó–µ–º–ª–µ–≤–ø–æ—Ä—è–¥–∫—É–≤–∞–Ω–Ω—è",
      "–ó–µ–ª–µ–Ω–µ –±—É–¥—ñ–≤–Ω–∏—Ü—Ç–≤–æ —ñ —Å–∞–¥–æ–≤–æ-–ø–∞—Ä–∫–æ–≤–µ –≥–æ—Å–ø–æ–¥–∞—Ä—Å—Ç–≤–æ",
      "–§—ñ–Ω–∞–Ω—Å–∏ —ñ –∫—Ä–µ–¥–∏—Ç",
      "–ë—É—Ö–≥–∞–ª—Ç–µ—Ä—Å—å–∫–∏–π –æ–±–ª—ñ–∫",
      "–û—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—è –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–∞",
      "–í–µ—Ç–µ—Ä–∏–Ω–∞—Ä—ñ—è"
    ];

    // –ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –∑–æ–≤–Ω—ñ—à–Ω—ñ —Ä–µ—Å—É—Ä—Å–∏
    const NOTEBOOK_LM_URL = "https://notebooklm.google.com/";
    
    // –°–ø–∏—Å–æ–∫ –º–æ–¥—É–ª—ñ–≤
    const MODULES = [
      { id:"m1", title:"–ú–æ–¥—É–ª—å 1. –í—Å—Ç—É–ø –¥–æ –±—ñ–æ–ª–æ–≥—ñ—ó. –í–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ –∂–∏–≤–æ–≥–æ", presentation:"#", notebook: NOTEBOOK_LM_URL },
      { id:"m2", title:"–ú–æ–¥—É–ª—å 2. –ö–ª—ñ—Ç–∏–Ω–∞ ‚Äì –æ–¥–∏–Ω–∏—Ü—è –∂–∏–≤–æ–≥–æ. –ü–æ–¥—ñ–ª –∫–ª—ñ—Ç–∏–Ω", presentation:"#", notebook: NOTEBOOK_LM_URL },
      { id:"m3", title:"–ú–æ–¥—É–ª—å 3. –•—ñ–º—ñ—á–Ω–∏–π —Å–∫–ª–∞–¥ –∫–ª—ñ—Ç–∏–Ω–∏. –ú–µ—Ç–∞–±–æ–ª—ñ–∑–º", presentation:"#", notebook: NOTEBOOK_LM_URL },
      { id:"m4", title:"–ú–æ–¥—É–ª—å 4. –û–¥–Ω–æ–∫–ª—ñ—Ç–∏–Ω–Ω—ñ –æ—Ä–≥–∞–Ω—ñ–∑–º–∏", presentation:"#", notebook: NOTEBOOK_LM_URL },
      { id:"m5", title:"–ú–æ–¥—É–ª—å 5. –†–æ—Å–ª–∏–Ω–∞ —è–∫ —Ü—ñ–ª—ñ—Å–Ω–∏–π –æ—Ä–≥–∞–Ω—ñ–∑–º", presentation:"#", notebook: NOTEBOOK_LM_URL },
      { id:"m6", title:"–ú–æ–¥—É–ª—å 6. –ö–æ—Ä—ñ–Ω—å: –±—É–¥–æ–≤–∞ —ñ –≤–∏–¥–æ–∑–º—ñ–Ω–∏", presentation:"#", notebook: NOTEBOOK_LM_URL },
      { id:"m7", title:"–ú–æ–¥—É–ª—å 7. –ü–∞–≥—ñ–Ω: —Ä–æ–∑–≤–∏—Ç–æ–∫ —ñ –≤–∏–¥–æ–∑–º—ñ–Ω–∏", presentation:"#", notebook: NOTEBOOK_LM_URL },
      { id:"m8", title:"–ú–æ–¥—É–ª—å 8. –õ–∏—Å—Ç–æ–∫. –§—ñ–∑—ñ–æ–ª–æ–≥—ñ—è —Ä–æ—Å–ª–∏–Ω", presentation:"#", notebook: NOTEBOOK_LM_URL },
      { id:"m9", title:"–ú–æ–¥—É–ª—å 9. –ì–µ–Ω–µ—Ä–∞—Ç–∏–≤–Ω—ñ –æ—Ä–≥–∞–Ω–∏: –∫–≤—ñ—Ç–∫–∞, –ø–ª—ñ–¥", presentation:"#", notebook: NOTEBOOK_LM_URL },
      { id:"m10", title:"–ú–æ–¥—É–ª—å 10. –†–æ–∑–º–Ω–æ–∂–µ–Ω–Ω—è —Ä–æ—Å–ª–∏–Ω", presentation:"#", notebook: NOTEBOOK_LM_URL }
    ];

    // -------------------------
    // 1) STATE MANAGEMENT (LocalStorage)
    // -------------------------
    const STORAGE_KEY = "biology_hub_state_v2";

    const defaultState = () => ({
      profile: { studentName: "", specialty: "", opp: OPP_LIST[0] },
      progress: {},   // { m1: { done: boolean, date: string, score: number } }
      notes: {},      // { m1: "User notes content..." }
      promptNotes: {} // { "m1|OPP_Name": "Notes..." }
    });

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : defaultState();
      } catch (e) {
        console.error("Storage Error", e);
        return defaultState();
      }
    }

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    let state = loadState();

    // -------------------------
    // 2) –ì–ï–ù–ï–†–ê–¢–û–† –ü–†–û–ú–ü–¢–Ü–í
    // -------------------------
    function generatePrompts(moduleId, opp) {
      const m = MODULES.find(x => x.id === moduleId);
      const title = m ? m.title : moduleId;

      return [
        { 
          id: "p1", 
          title: "ü§ì –ü–æ—è—Å–Ω–µ–Ω–Ω—è —Ç–µ–º–∏ (–¢–µ–æ—Ä—ñ—è)", 
          text: `–¢–∏ - –≤–∏–∫–ª–∞–¥–∞—á –±—ñ–æ–ª–æ–≥—ñ—ó –¥–ª—è –∞–≥—Ä–∞—Ä–Ω–æ–≥–æ –∫–æ–ª–µ–¥–∂—É.
–¢–µ–º–∞: "${title}".
–°–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å (–û–ü–ü): "${opp}".

–ó–∞–≤–¥–∞–Ω–Ω—è:
1. –ü–æ—è—Å–Ω–∏ —Ç–µ–º—É –ø—Ä–æ—Å—Ç–æ—é –º–æ–≤–æ—é, –∞–∫—Ü–µ–Ω—Ç—É—é—á–∏ –Ω–∞ –ø—Ä–∞–∫—Ç–∏—á–Ω–æ–º—É –∑–Ω–∞—á–µ–Ω–Ω—ñ –¥–ª—è —Ü—ñ—î—ó —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç—ñ.
2. –ù–∞–≤–µ–¥–∏ 3 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ñ –ø—Ä–∏–∫–ª–∞–¥–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —Ü–∏—Ö –∑–Ω–∞–Ω—å —É –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω—ñ–π –¥—ñ—è–ª—å–Ω–æ—Å—Ç—ñ –∞–≥—Ä–æ–Ω–æ–º–∞/–∑–µ–º–ª–µ–≤–ø–æ—Ä—è–¥–Ω–∏–∫–∞/—Ç–æ—â–æ (–≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –¥–æ –û–ü–ü).
3. –°—Ñ–æ—Ä–º—É–ª—é–π 5 –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∏—Ö –∑–∞–ø–∏—Ç–∞–Ω—å –∑ –∫–æ—Ä–æ—Ç–∫–∏–º–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—è–º–∏ –¥–ª—è —Å–∞–º–æ–ø–µ—Ä–µ–≤—ñ—Ä–∫–∏.` 
        },
        { 
          id: "p2", 
          title: "üöú –ü—Ä–∞–∫—Ç–∏—á–Ω–∏–π –∫–µ–π—Å (Situation)", 
          text: `–¢–∏ - –º–µ–Ω—Ç–æ—Ä –∑ –ø—Ä–∞–∫—Ç–∏—á–Ω–æ—ó –ø—ñ–¥–≥–æ—Ç–æ–≤–∫–∏.
–¢–µ–º–∞: "${title}".
–û–ü–ü: "${opp}".

–°—Ç–≤–æ—Ä–∏ –ø—Ä–∞–∫—Ç–∏—á–Ω–∏–π –∫–µ–π—Å (—Å–∏—Ç—É–∞—Ü—ñ–π–Ω—É –∑–∞–¥–∞—á—É):
1. –û–ø–∏—Å —Å–∏—Ç—É–∞—Ü—ñ—ó: –†–µ–∞–ª—å–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ –≤ –≥–æ—Å–ø–æ–¥–∞—Ä—Å—Ç–≤—ñ/–Ω–∞ –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤—ñ, –ø–æ–≤'—è–∑–∞–Ω–∞ –∑ —Ç–µ–º–æ—é.
2. –í—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ: –©–æ –±–∞—á–∏—Ç—å/–º–∞—î —Ñ–∞—Ö—ñ–≤–µ—Ü—å.
3. –ó–∞–≤–¥–∞–Ω–Ω—è: –©–æ —Ç—Ä–µ–±–∞ –∑—Ä–æ–±–∏—Ç–∏/–≤–∏–∑–Ω–∞—á–∏—Ç–∏ (3-4 –ø—É–Ω–∫—Ç–∏).
4. –ö—Ä–∏—Ç–µ—Ä—ñ—ó –æ—Ü—ñ–Ω—é–≤–∞–Ω–Ω—è: –Ø–∫ –≤–∏–≥–ª—è–¥–∞—î —ñ–¥–µ–∞–ª—å–Ω–µ —Ä—ñ—à–µ–Ω–Ω—è.
5. –ó—Ä–∞–∑–æ–∫ —Ä–æ–∑–≤'—è–∑–∞–Ω–Ω—è.` 
        },
        { 
          id: "p3", 
          title: "üìö –ì–ª–æ—Å–∞—Ä—ñ–π (–ö–∞—Ä—Ç–∫–∏)", 
          text: `–°—Ç–≤–æ—Ä–∏ —Å–ø–∏—Å–æ–∫ —ñ–∑ 15 –∫–ª—é—á–æ–≤–∏—Ö —Ç–µ—Ä–º—ñ–Ω—ñ–≤ –¥–æ —Ç–µ–º–∏ "${title}" –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤ –û–ü–ü "${opp}".
–§–æ—Ä–º–∞—Ç: –¢–µ—Ä–º—ñ–Ω - –ø—Ä–æ—Å—Ç–µ –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è (1 —Ä–µ—á–µ–Ω–Ω—è) - –∞—Å–æ—Ü—ñ–∞—Ü—ñ—è –∞–±–æ –ø—Ä–∏–∫–ª–∞–¥.` 
        }
      ];
    }

    // -------------------------
    // 3) HELPERS
    // -------------------------
    const escapeHtml = (str) => String(str ?? "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
    const todayISO = () => new Date().toISOString().split('T')[0];
    const clamp = (val, min, max) => Math.min(Math.max(parseInt(val) || 0, min), max);

    async function copyToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        showToast("–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É!");
      } catch (err) {
        alert("–ù–µ –≤–¥–∞–ª–æ—Å—è —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ.");
      }
    }

    function showToast(msg) {
      const div = document.createElement("div");
      div.className = "fixed bottom-5 right-5 bg-emerald-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-bounce";
      div.textContent = msg;
      document.body.appendChild(div);
      setTimeout(() => div.remove(), 2000);
    }

    // SVG Icons
    const Icons = {
      dashboard: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>`,
      modules: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>`,
      workbook: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>`,
      prompts: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>`,
      export: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>`,
      download: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>`
    };

    // -------------------------
    // 4) LAYOUT & ROUTING
    // -------------------------
    function Layout(title, content, activePath) {
      const navItem = (path, icon, label) => `
        <a href="#${path}" class="nav-link ${activePath === path ? 'active' : ''}">
          ${icon} <span>${label}</span>
        </a>`;

      return `
        <div class="no-print">
          <header class="border-b border-slate-800 bg-slate-950/80 backdrop-blur-md sticky top-0 z-50">
            <div class="max-w-6xl mx-auto px-4 py-3 flex flex-col md:flex-row items-center justify-between gap-4">
              <div class="flex items-center gap-3">
                <div class="bg-emerald-600 w-8 h-8 rounded-lg flex items-center justify-center font-bold text-white">B</div>
                <div>
                  <h1 class="text-lg font-bold tracking-tight text-white">BIOLOGY SMART-HUB 2.0</h1>
                  <div class="text-[10px] text-slate-400 uppercase tracking-widest font-semibold">–¶–∏—Ñ—Ä–æ–≤–∞ –µ–∫–æ—Å–∏—Å—Ç–µ–º–∞</div>
                </div>
              </div>
              <nav class="flex flex-wrap items-center gap-1">
                ${navItem('/dashboard', Icons.dashboard, '–ü–∞–Ω–µ–ª—å')}
                ${navItem('/modules', Icons.modules, '–ú–æ–¥—É–ª—ñ')}
                ${navItem('/workbook', Icons.workbook, '–ó–æ—à–∏—Ç')}
                ${navItem('/prompts', Icons.prompts, 'AI –ü—Ä–æ–º–ø—Ç–∏')}
                ${navItem('/export', Icons.export, '–ó–≤—ñ—Ç')}
              </nav>
            </div>
          </header>
        </div>
        <main class="flex-grow max-w-6xl w-full mx-auto px-4 py-8 fade-in">
          <h2 class="text-2xl font-bold mb-6 text-slate-100 border-l-4 border-emerald-500 pl-4">${escapeHtml(title)}</h2>
          ${content}
        </main>
        <footer class="no-print border-t border-slate-800 mt-auto py-6 text-center text-slate-500 text-sm">
          &copy; ${new Date().getFullYear()} Biology Smart-Hub. –í—Å—ñ –¥–∞–Ω—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ.
        </footer>
      `;
    }

    // --- COMPONENTS ---

    function Card(title, bodyHtml, footerHtml = "") {
      return `
        <div class="rounded-2xl border border-slate-800 bg-slate-900/50 p-6 shadow-sm">
          <h3 class="font-semibold text-lg text-emerald-400 mb-3">${escapeHtml(title)}</h3>
          <div class="text-slate-300 text-sm leading-relaxed">${bodyHtml}</div>
          ${footerHtml ? `<div class="mt-4 pt-4 border-t border-slate-800/50 flex gap-2">${footerHtml}</div>` : ""}
        </div>`;
    }

    // --- PAGES ---

    function DashboardPage() {
      const total = MODULES.length;
      const done = MODULES.filter(m => state.progress[m.id]?.done).length;
      const pct = Math.round((done / total) * 100);

      const profileForm = `
        <div class="space-y-4">
          <div>
            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">–ü—Ä—ñ–∑–≤–∏—â–µ —Ç–∞ –Ü–º'—è</label>
            <input id="inName" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2.5 text-white focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 outline-none" 
              value="${escapeHtml(state.profile.studentName)}" placeholder="–Ü–≤–∞–Ω–µ–Ω–∫–æ –ü–µ—Ç—Ä–æ">
          </div>
          <div>
            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">–°–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å</label>
            <input id="inSpec" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2.5 text-white outline-none" 
              value="${escapeHtml(state.profile.specialty)}" placeholder="–ê–≥—Ä–æ–Ω–æ–º—ñ—è">
          </div>
          <div>
            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">–û—Å–≤—ñ—Ç–Ω—è –ø—Ä–æ–≥—Ä–∞–º–∞ (–û–ü–ü)</label>
            <select id="inOpp" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2.5 text-white outline-none">
              ${OPP_LIST.map(o => `<option ${state.profile.opp === o ? "selected" : ""}>${escapeHtml(o)}</option>`).join("")}
            </select>
          </div>
        </div>
      `;

      const progressHtml = `
        <div class="flex items-end justify-between mb-2">
          <span class="text-4xl font-bold text-white">${pct}%</span>
          <span class="text-sm text-slate-400">–ó–∞–≤–µ—Ä—à–µ–Ω–æ ${done} –∑ ${total} –º–æ–¥—É–ª—ñ–≤</span>
        </div>
        <div class="w-full bg-slate-800 rounded-full h-4 overflow-hidden">
          <div class="bg-gradient-to-r from-emerald-600 to-teal-400 h-4 rounded-full transition-all duration-1000" style="width: ${pct}%"></div>
        </div>
        <div class="mt-6 text-sm text-slate-400">
          –ü—Ä–æ–¥–æ–≤–∂—É–π—Ç–µ –Ω–∞–≤—á–∞–Ω–Ω—è, —â–æ–± –∑–∞–ø–æ–≤–Ω–∏—Ç–∏ —Å–≤—ñ–π —Ü–∏—Ñ—Ä–æ–≤–∏–π –∑–æ—à–∏—Ç.
        </div>
      `;

      const content = `
        <div class="grid md:grid-cols-2 gap-6">
          ${Card("–ú—ñ–π –ü—Ä–æ—Ñ—ñ–ª—å", profileForm, `<button id="btnSaveProfile" class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg font-medium transition-colors w-full">–ó–±–µ—Ä–µ–≥—Ç–∏ –¥–∞–Ω—ñ</button>`)}
          ${Card("–ú—ñ–π –ü—Ä–æ–≥—Ä–µ—Å", progressHtml, `<a href="#/modules" class="text-emerald-400 hover:text-emerald-300 text-sm font-semibold flex items-center gap-1">–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –º–æ–¥—É–ª—ñ–≤ &rarr;</a>`)}
        </div>
        <div class="mt-6">
          ${Card("üìå –ü—Ä–æ —Ü–µ–π —Ö–∞–±", "–¶–µ –≤–∞—à–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–µ –Ω–∞–≤—á–∞–ª—å–Ω–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ. –¢—É—Ç –≤–∏ –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–≥–ª—è–¥–∞—Ç–∏ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏, –≤–µ—Å—Ç–∏ –∫–æ–Ω—Å–ø–µ–∫—Ç —É —Ñ–æ—Ä–º–∞—Ç—ñ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–≥–æ –∑–æ—à–∏—Ç–∞, –≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –ø—ñ–¥–∫–∞–∑–∫–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –®–Ü —Ç–∞ —Ñ–æ—Ä–º—É–≤–∞—Ç–∏ –∑–≤—ñ—Ç –¥–ª—è –≤–∏–∫–ª–∞–¥–∞—á–∞. –í—Å—ñ –¥–∞–Ω—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ —É –≤–∞—à–æ–º—É –±—Ä–∞—É–∑–µ—Ä—ñ.")}
        </div>
      `;

      render(Layout("–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è", content, "/dashboard"));

      document.getElementById("btnSaveProfile").onclick = () => {
        state.profile.studentName = document.getElementById("inName").value;
        state.profile.specialty = document.getElementById("inSpec").value;
        state.profile.opp = document.getElementById("inOpp").value;
        saveState();
        showToast("–ü—Ä–æ—Ñ—ñ–ª—å –æ–Ω–æ–≤–ª–µ–Ω–æ!");
      };
    }

    function ModulesPage() {
      const listHtml = MODULES.map(m => {
        const p = state.progress[m.id] || {};
        const isDone = p.done;
        
        return `
          <div class="group relative bg-slate-900/40 border border-slate-800 rounded-xl p-5 hover:border-emerald-500/50 transition-all">
            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
              <div>
                <div class="flex items-center gap-2 mb-1">
                  <span class="text-xs font-bold px-2 py-0.5 rounded ${isDone ? 'bg-emerald-900/50 text-emerald-400' : 'bg-slate-800 text-slate-400'}">
                    ${isDone ? '–í–ò–ö–û–ù–ê–ù–û' : '–£ –†–û–ë–û–¢–Ü'}
                  </span>
                  ${p.score ? `<span class="text-xs font-bold px-2 py-0.5 rounded bg-amber-900/30 text-amber-400">–û—Ü—ñ–Ω–∫–∞: ${p.score}</span>` : ''}
                </div>
                <h3 class="font-semibold text-lg text-slate-100 group-hover:text-emerald-400 transition-colors">${escapeHtml(m.title)}</h3>
                <div class="text-xs text-slate-500 mt-1">
                  ${p.date ? `–û—Å—Ç–∞–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å: ${p.date}` : '–©–µ –Ω–µ —Ä–æ–∑–ø–æ—á–∞—Ç–æ'}
                </div>
              </div>
              <div class="flex gap-2">
                <a href="#/workbook?m=${m.id}" class="bg-slate-800 hover:bg-slate-700 text-slate-200 px-4 py-2 rounded-lg text-sm font-medium transition-colors">–í—ñ–¥–∫—Ä–∏—Ç–∏ –∑–æ—à–∏—Ç</a>
                <button onclick="toggleDone('${m.id}')" class="p-2 rounded-lg border border-slate-700 hover:bg-slate-800 text-slate-400 hover:text-white transition-colors" title="–°—Ç–∞—Ç—É—Å">
                  ${isDone ? '‚Ü©Ô∏è' : '‚úÖ'}
                </button>
              </div>
            </div>
          </div>
        `;
      }).join("");

      render(Layout("–ù–∞–≤—á–∞–ª—å–Ω—ñ –º–æ–¥—É–ª—ñ", `<div class="space-y-3">${listHtml}</div>`, "/modules"));

      window.toggleDone = (mid) => {
        const current = state.progress[mid] || {};
        const score = current.done ? current.score : (prompt("–í–∞—à–∞ —Å–∞–º–æ–æ—Ü—ñ–Ω–∫–∞ –∑–∞ –º–æ–¥—É–ª—å (1-12):") || null);
        
        state.progress[mid] = {
          done: !current.done,
          date: todayISO(),
          score: score ? clamp(score, 1, 12) : null
        };
        saveState();
        ModulesPage(); // Re-render
      };
    }

    function WorkbookPage() {
      const params = new URLSearchParams(location.hash.split("?")[1]);
      const mid = params.get("m") || MODULES[0].id;
      const module = MODULES.find(x => x.id === mid) || MODULES[0];
      const p = state.progress[module.id] || {};
      const noteContent = state.notes[module.id] || "";

      const navTabs = MODULES.map(m => `
        <a href="#/workbook?m=${m.id}" 
           class="block w-full text-left px-3 py-2 rounded-md text-xs font-medium truncate transition-colors
           ${m.id === mid ? 'bg-emerald-600 text-white shadow-md' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}">
           ${m.id.toUpperCase()}
        </a>
      `).join("");

      const content = `
        <div class="flex flex-col lg:flex-row gap-6 items-start">
          <!-- Sidebar -->
          <div class="w-full lg:w-48 flex-shrink-0 grid grid-cols-3 lg:grid-cols-1 gap-2 sticky top-24">
            ${navTabs}
          </div>

          <!-- Main Paper Area -->
          <div class="flex-grow w-full">
            <div class="paper w-full max-w-4xl mx-auto transform transition-all hover:scale-[1.002]">
              <div class="paper-header flex justify-between items-start">
                <div>
                  <div class="paper-title text-emerald-950">–õ–ê–ë–û–†–ê–¢–û–†–ù–ò–ô –ó–û–®–ò–¢</div>
                  <div class="paper-sub">${escapeHtml(module.title)}</div>
                </div>
                <div class="text-right">
                  <div class="text-xs text-slate-400 uppercase tracking-widest font-bold">–û—Ü—ñ–Ω–∫–∞</div>
                  <div class="text-2xl font-handwriting text-red-600 font-bold transform -rotate-6">${p.score || "‚Äî"}/12</div>
                </div>
              </div>

              <div class="bg-white p-6 border-b border-slate-100 flex flex-wrap gap-4 items-center justify-between">
                <div class="flex gap-2">
                  <a href="${module.presentation}" target="_blank" class="flex items-center gap-2 px-4 py-2 bg-blue-50 text-blue-700 rounded-full text-sm font-semibold hover:bg-blue-100 transition-colors">
                    üìë –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü—ñ—è
                  </a>
                  <a href="${module.notebook}" target="_blank" class="flex items-center gap-2 px-4 py-2 bg-purple-50 text-purple-700 rounded-full text-sm font-semibold hover:bg-purple-100 transition-colors">
                    ü§ñ NotebookLM
                  </a>
                  <a href="#/prompts?m=${mid}" class="flex items-center gap-2 px-4 py-2 bg-emerald-50 text-emerald-700 rounded-full text-sm font-semibold hover:bg-emerald-100 transition-colors">
                    ‚ú® AI –ü—ñ–¥–∫–∞–∑–∫–∏
                  </a>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-xs text-slate-400 uppercase font-bold">–î–∞—Ç–∞:</span>
                  <input type="date" id="wbDate" value="${p.date || todayISO()}" class="bg-transparent border-b border-slate-300 text-slate-700 text-sm focus:outline-none focus:border-emerald-500 w-32">
                </div>
              </div>

              <!-- Lined Area -->
              <div class="lined p-0 relative">
                <!-- Textarea positioning to match lines (line-height 28px) -->
                <textarea id="wbNote" class="lined-input w-full min-h-[500px] h-full" 
                  placeholder="–ó–∞–ø–∏—à—ñ—Ç—å —Ç—É—Ç —Ö—ñ–¥ —Ä–æ–±–æ—Ç–∏, —Å–ø–æ—Å—Ç–µ—Ä–µ–∂–µ–Ω–Ω—è —Ç–∞ –≤–∏—Å–Ω–æ–≤–∫–∏...">${escapeHtml(noteContent)}</textarea>
              </div>

              <div class="bg-slate-50 border-t border-slate-200 p-4 flex justify-between items-center">
                 <div class="flex gap-2">
                   <button id="btnDownloadWb" class="flex items-center gap-1 px-3 py-2 rounded-lg bg-white border border-slate-300 text-slate-700 text-xs font-semibold hover:bg-slate-50 transition-colors">
                      ${Icons.download} –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–∞–π–ª
                   </button>
                 </div>
                 <button id="btnSaveWb" class="btn-dark bg-emerald-700 hover:bg-emerald-800 text-white shadow-lg shadow-emerald-900/20">
                    üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –∑–∞–ø–∏—Å
                 </button>
              </div>
            </div>
          </div>
        </div>
      `;

      render(Layout("–†–æ–±–æ—á–∏–π –∑–æ—à–∏—Ç", content, "/workbook"));

      // Auto-resize textarea
      const ta = document.getElementById("wbNote");
      ta.style.height = "auto";
      ta.style.height = (ta.scrollHeight) + "px";
      ta.oninput = function() {
        this.style.height = "auto";
        this.style.height = (this.scrollHeight) + "px";
      }

      document.getElementById("btnSaveWb").onclick = () => {
        const txt = document.getElementById("wbNote").value;
        const date = document.getElementById("wbDate").value;
        
        state.notes[mid] = txt;
        state.progress[mid] = { ...p, date: date, done: true }; 
        saveState();
        showToast("–ó–æ—à–∏—Ç –∑–±–µ—Ä–µ–∂–µ–Ω–æ!");
      };

      document.getElementById("btnDownloadWb").onclick = () => {
        downloadWorkbook(mid);
      };

      // –§—É–Ω–∫—Ü—ñ—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó —Ñ–∞–π–ª—É –∑–æ—à–∏—Ç–∞
      window.downloadWorkbook = (moduleId) => {
         const m = MODULES.find(x => x.id === moduleId);
         const note = document.getElementById("wbNote").value;
         const date = document.getElementById("wbDate").value;
         const profile = state.profile;
         const currentP = state.progress[moduleId] || {};

         const htmlContent = `<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>–ó–æ—à–∏—Ç - ${m.title}</title>
<style>
  body { font-family: sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; line-height: 1.6; color: #333; }
  h1 { border-bottom: 2px solid #10b981; padding-bottom: 10px; color: #064e3b; }
  .meta { background: #f0fdf4; padding: 20px; border-radius: 8px; margin-bottom: 30px; border: 1px solid #bbf7d0; }
  .content { white-space: pre-wrap; background: #fff; border: 1px solid #ccc; padding: 20px; min-height: 300px; border-radius: 4px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); }
</style>
</head>
<body>
  <h1>${m.title}</h1>
  <div class="meta">
    <strong>–°—Ç—É–¥–µ–Ω—Ç:</strong> ${profile.studentName || "–ù–µ –≤–∫–∞–∑–∞–Ω–æ"}<br>
    <strong>–°–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å:</strong> ${profile.specialty || "‚Äî"}<br>
    <strong>–û–ü–ü:</strong> ${profile.opp || "‚Äî"}<br>
    <strong>–î–∞—Ç–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è:</strong> ${date}<br>
    <strong>–û—Ü—ñ–Ω–∫–∞:</strong> ${currentP.score || "‚Äî"}
  </div>
  <h3>–•—ñ–¥ —Ä–æ–±–æ—Ç–∏ / –í–∏—Å–Ω–æ–≤–∫–∏:</h3>
  <div class="content">${note}</div>
  <hr style="margin-top: 40px; border: 0; border-top: 1px solid #eee;">
  <small style="color: #888;">–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ —É Biology Smart-Hub 2.0</small>
</body>
</html>`;

         const blob = new Blob([htmlContent], { type: "text/html" });
         const link = document.createElement("a");
         link.href = URL.createObjectURL(blob);
         link.download = `Zoshyt_${m.id}_${profile.studentName || "student"}.html`;
         document.body.appendChild(link);
         link.click();
         document.body.removeChild(link);
         showToast("–§–∞–π–ª –∑–æ—à–∏—Ç–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ!");
      };
    }

    function PromptsPage() {
      const params = new URLSearchParams(location.hash.split("?")[1]);
      const mid = params.get("m") || MODULES[0].id;
      const prompts = generatePrompts(mid, state.profile.opp);
      const noteKey = `${mid}|${state.profile.opp}`;
      const savedNote = state.promptNotes[noteKey] || "";

      const moduleSelect = `
        <select id="selMod" class="bg-slate-900 border border-slate-700 text-white rounded-lg p-2 text-sm w-full outline-none focus:border-emerald-500 transition-colors">
          ${MODULES.map(m => `<option value="${m.id}" ${m.id === mid ? "selected" : ""}>${escapeHtml(m.title)}</option>`).join("")}
        </select>
      `;

      const oppSelect = `
        <select id="selOpp" class="bg-slate-900 border border-slate-700 text-white rounded-lg p-2 text-sm w-full outline-none focus:border-emerald-500 transition-colors">
          ${OPP_LIST.map(o => `<option ${state.profile.opp === o ? "selected" : ""}>${escapeHtml(o)}</option>`).join("")}
        </select>
      `;

      const promptCards = prompts.map(p => `
        <div class="bg-slate-800/50 border border-slate-700/50 rounded-xl p-4 hover:border-emerald-500/30 transition-all">
          <div class="flex justify-between items-start mb-2">
            <h4 class="font-bold text-emerald-400 text-sm uppercase tracking-wide">${escapeHtml(p.title)}</h4>
            <button onclick="copyPrompt('${p.id}')" class="text-xs bg-slate-700 hover:bg-emerald-600 text-white px-2 py-1 rounded transition-colors">–ö–æ–ø—ñ—é–≤–∞—Ç–∏</button>
          </div>
          <pre id="pt_${p.id}" class="text-xs text-slate-300 whitespace-pre-wrap font-mono bg-slate-950/50 p-3 rounded-lg border border-slate-800 select-all">${escapeHtml(p.text)}</pre>
        </div>
      `).join("");

      const content = `
        <div class="mb-6 flex flex-col md:flex-row gap-4 items-start justify-between bg-slate-900/50 p-4 rounded-xl border border-slate-800">
          <div class="flex-1 w-full">
            <label class="text-xs text-slate-500 block mb-1 uppercase font-bold">–û–±–µ—Ä—ñ—Ç—å –º–æ–¥—É–ª—å</label>
            ${moduleSelect}
          </div>
          <div class="flex-1 w-full">
            <label class="text-xs text-slate-500 block mb-1 uppercase font-bold">–°–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å (–û–ü–ü)</label>
            ${oppSelect}
          </div>
        </div>

        <div class="grid lg:grid-cols-2 gap-6">
          <div class="space-y-4">
            <h3 class="font-bold text-white">1. –°–∫–æ–ø—ñ—é–π—Ç–µ –ø—Ä–æ–º–ø—Ç</h3>
            ${promptCards}
          </div>

          <div class="space-y-4">
            <h3 class="font-bold text-white">2. –í—Å—Ç–∞–≤—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –®–Ü</h3>
            <div class="bg-slate-800/30 border border-slate-700 rounded-xl p-1">
              <textarea id="aiNote" class="w-full h-[500px] bg-transparent text-slate-200 p-4 resize-none outline-none font-mono text-sm" 
                placeholder="–í—Å—Ç–∞–≤—Ç–µ —Å—é–¥–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å ChatGPT/Gemini, —â–æ–± –Ω–µ –∑–∞–≥—É–±–∏—Ç–∏...">${escapeHtml(savedNote)}</textarea>
            </div>
            <button id="btnSaveAiNote" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-lg font-bold shadow-lg shadow-emerald-900/20 transition-all">
              –ó–±–µ—Ä–µ–≥—Ç–∏ –Ω–æ—Ç–∞—Ç–∫—É
            </button>
          </div>
        </div>
      `;

      render(Layout("–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ü—Ä–æ–º–ø—Ç—ñ–≤", content, "/prompts"));

      // Events
      document.getElementById("selMod").onchange = (e) => {
        location.hash = `#/prompts?m=${e.target.value}`;
      };

      document.getElementById("selOpp").onchange = (e) => {
        state.profile.opp = e.target.value;
        saveState();
        PromptsPage(); // Re-render to update prompts text immediately
        showToast("–û–ü–ü –∑–º—ñ–Ω–µ–Ω–æ, –ø—Ä–æ–º–ø—Ç–∏ –æ–Ω–æ–≤–ª–µ–Ω–æ!");
      };

      document.getElementById("btnSaveAiNote").onclick = () => {
        state.promptNotes[noteKey] = document.getElementById("aiNote").value;
        saveState();
        showToast("–ù–æ—Ç–∞—Ç–∫—É –∑–±–µ—Ä–µ–∂–µ–Ω–æ!");
      };

      window.copyPrompt = (pid) => {
        const text = document.getElementById(`pt_${pid}`).innerText;
        copyToClipboard(text);
      };
    }

    function ExportPage() {
      const rows = MODULES.map((m, i) => {
        const p = state.progress[m.id] || {};
        const note = state.notes[m.id] || "";
        const shortNote = note.length > 50 ? note.substring(0, 50) + "..." : (note || "‚Äî");
        
        return `
          <tr class="border-b border-slate-700 hover:bg-slate-800/30">
            <td class="py-3 px-2 text-slate-300">${i + 1}</td>
            <td class="py-3 px-2 text-white font-medium">${escapeHtml(m.title)}</td>
            <td class="py-3 px-2 text-center">${p.score || "‚Äî"}</td>
            <td class="py-3 px-2 text-center text-xs font-mono">${p.date || "‚Äî"}</td>
            <td class="py-3 px-2 text-slate-400 text-xs italic">${escapeHtml(shortNote)}</td>
          </tr>
        `;
      }).join("");

      const content = `
        <div class="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full text-sm text-left">
              <thead class="bg-slate-950 text-slate-400 uppercase text-xs">
                <tr>
                  <th class="py-3 px-2">#</th>
                  <th class="py-3 px-2">–¢–µ–º–∞</th>
                  <th class="py-3 px-2 text-center">–ë–∞–ª</th>
                  <th class="py-3 px-2 text-center">–î–∞—Ç–∞</th>
                  <th class="py-3 px-2">–ù–æ—Ç–∞—Ç–∫–∞ (—É—Ä–∏–≤–æ–∫)</th>
                </tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
        </div>

        <div class="mt-8 text-center">
          <button onclick="printReport()" class="inline-flex items-center gap-2 bg-white text-slate-900 hover:bg-slate-100 font-bold py-3 px-6 rounded-xl shadow-lg transition-transform transform hover:-translate-y-1">
            ${Icons.export} –°—Ñ–æ—Ä–º—É–≤–∞—Ç–∏ PDF-–∑–≤—ñ—Ç
          </button>
          <p class="mt-3 text-xs text-slate-500">
            –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É, –∞ –ø–æ—Ç—ñ–º —É –≤—ñ–∫–Ω—ñ –¥—Ä—É–∫—É –≤–∏–±–µ—Ä—ñ—Ç—å "–ó–±–µ—Ä–µ–≥—Ç–∏ —è–∫ PDF".
          </p>
        </div>
      `;

      render(Layout("–ï–∫—Å–ø–æ—Ä—Ç —Ç–∞ –ó–≤—ñ—Ç–Ω—ñ—Å—Ç—å", content, "/export"));

      window.printReport = () => {
        const printDiv = document.getElementById("printArea");
        
        // –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –ø–æ–≤–Ω–æ–≥–æ HTML –¥–ª—è –¥—Ä—É–∫—É
        let html = `
          <div style="font-family: serif; padding: 40px; color: #000;">
            <div style="text-align: center; border-bottom: 2px solid #000; padding-bottom: 20px; margin-bottom: 30px;">
              <h1 style="font-size: 24px; font-weight: bold; margin: 0;">–ó–í–Ü–¢ –ü–†–û –í–ò–ö–û–ù–ê–ù–ù–Ø –õ–ê–ë–û–†–ê–¢–û–†–ù–ò–• –†–û–ë–Ü–¢</h1>
              <h2 style="font-size: 16px; margin: 5px 0;">–î–∏—Å—Ü–∏–ø–ª—ñ–Ω–∞: –ë—ñ–æ–ª–æ–≥—ñ—è</h2>
            </div>

            <div style="margin-bottom: 30px;">
              <p><strong>–°—Ç—É–¥–µ–Ω—Ç:</strong> ${escapeHtml(state.profile.studentName || "_________________")}</p>
              <p><strong>–°–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å:</strong> ${escapeHtml(state.profile.specialty)}</p>
              <p><strong>–û–ü–ü:</strong> ${escapeHtml(state.profile.opp)}</p>
              <p><strong>–î–∞—Ç–∞ —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—è:</strong> ${todayISO()}</p>
            </div>

            <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px; font-size: 14px;">
              <thead>
                <tr style="background: #f0f0f0;">
                  <th style="border: 1px solid #000; padding: 8px;">–ú–æ–¥—É–ª—å</th>
                  <th style="border: 1px solid #000; padding: 8px;">–î–∞—Ç–∞</th>
                  <th style="border: 1px solid #000; padding: 8px;">–û—Ü—ñ–Ω–∫–∞</th>
                </tr>
              </thead>
              <tbody>
                ${MODULES.map(m => {
                  const p = state.progress[m.id] || {};
                  return `
                    <tr>
                      <td style="border: 1px solid #000; padding: 8px;">${escapeHtml(m.title)}</td>
                      <td style="border: 1px solid #000; padding: 8px; text-align: center;">${p.date || "‚Äî"}</td>
                      <td style="border: 1px solid #000; padding: 8px; text-align: center;">${p.score || "‚Äî"}</td>
                    </tr>`;
                }).join("")}
              </tbody>
            </table>

            <h3 style="margin-top: 20px; border-bottom: 1px solid #ccc;">–î–µ—Ç–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ –∑–∞–ø–∏—Å–∏ (–í–∏–±—ñ—Ä–∫–∞):</h3>
            ${MODULES.map(m => {
              const note = state.notes[m.id];
              if (!note) return "";
              return `
                <div style="margin-top: 15px; page-break-inside: avoid;">
                  <h4 style="margin: 0; font-size: 14px; text-decoration: underline;">${escapeHtml(m.title)}</h4>
                  <pre style="white-space: pre-wrap; font-family: sans-serif; font-size: 12px; margin-top: 5px; color: #333;">${escapeHtml(note)}</pre>
                </div>
              `;
            }).join("")}
          </div>
        `;

        printDiv.innerHTML = html;
        window.print();
      };
    }

    // -------------------------
    // 5) CORE ROUTER
    // -------------------------
    function render(html) {
      document.getElementById("app").innerHTML = html;
      window.scrollTo(0, 0);
    }

    function router() {
      const hash = location.hash || "#/dashboard";
      const path = hash.split("?")[0].replace("#", "");

      switch(path) {
        case "/dashboard": DashboardPage(); break;
        case "/modules": ModulesPage(); break;
        case "/workbook": WorkbookPage(); break;
        case "/prompts": PromptsPage(); break;
        case "/export": ExportPage(); break;
        default: DashboardPage();
      }
    }

    window.addEventListener("hashchange", router);
    window.addEventListener("load", router);

  </script>
</body>
</html>
